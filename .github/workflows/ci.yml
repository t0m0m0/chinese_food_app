name: ç”ºä¸­è¯ã‚¢ãƒ—ãƒª CI/CD

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

jobs:
  # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
  code-quality:
    runs-on: ubuntu-latest
    name: ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: Flutterç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.5'
        channel: 'stable'
        cache: true
        
    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: flutter pub get
      
    - name: ã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
      run: flutter packages pub run build_runner build --delete-conflicting-outputs || echo "No build_runner configured"
      
    - name: é™çš„è§£æžã‚’å®Ÿè¡Œ
      run: flutter analyze
      
    - name: ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆã‚’ãƒã‚§ãƒƒã‚¯
      run: dart format --set-exit-if-changed .
      
    - name: Pubspecä¾å­˜é–¢ä¿‚ã‚’ãƒã‚§ãƒƒã‚¯
      run: flutter pub deps

  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  test:
    runs-on: ubuntu-latest
    name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    needs: code-quality
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: Flutterç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.5'
        channel: 'stable'
        cache: true
        
    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: flutter pub get
      
    - name: ã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
      run: flutter packages pub run build_runner build --delete-conflicting-outputs || echo "No build_runner configured"
    
    - name: ãƒ†ã‚¹ãƒˆç”¨ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
      run: ./.github/scripts/setup-test-env.sh
      
    - name: å˜ä½“ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆç’°å¢ƒå¤‰æ•°ãƒ‡ãƒãƒƒã‚°ä»˜ãï¼‰
      run: ./.github/scripts/run-tests-with-debug.sh
        
    - name: ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: codecov/codecov-action@v3
      with:
        file: coverage/lcov.info
        fail_ci_if_error: false

  # ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆï¼ˆAndroidï¼‰
  build-android:
    runs-on: ubuntu-latest
    name: Androidãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
    needs: test
    env:
      # CIç’°å¢ƒç”¨ã®ãƒ€ãƒŸãƒ¼GoogleMaps APIã‚­ãƒ¼è¨­å®š
      GOOGLE_MAPS_API_KEY: "AIzaSyDUMMY_KEY_FOR_CI_ENVIRONMENT_12345"
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: Javaç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Flutterç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.5'
        channel: 'stable'
        cache: true
        
    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: flutter pub get

    - name: ãƒ“ãƒ«ãƒ‰ç”¨ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
      env:
        HOTPEPPER_API_KEY_PROD: ${{ secrets.HOTPEPPER_API_KEY_PROD }}
        GOOGLE_MAPS_API_KEY_PROD: ${{ secrets.GOOGLE_MAPS_API_KEY_PROD }}
      run: ./.github/scripts/setup-build-env.sh
    
    - name: Android APKã‚’ãƒ“ãƒ«ãƒ‰
      run: flutter build apk --debug
      
    - name: ãƒ“ãƒ«ãƒ‰æˆæžœç‰©ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      with:
        name: android-apk-debug
        path: build/app/outputs/flutter-apk/app-debug.apk
        retention-days: 7

  # ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆï¼ˆWebï¼‰- Driftä½¿ç”¨ã«ã‚ˆã‚Šä¸€æ™‚çš„ã«ã‚¹ã‚­ãƒƒãƒ—
  # build-web:
  #   runs-on: ubuntu-latest
  #   name: Webãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ
  #   needs: test
    
  #   steps:
  #   - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
  #     uses: actions/checkout@v4
      
  #   - name: Flutterç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  #     uses: subosito/flutter-action@v2
  #     with:
  #       flutter-version: '3.32.5'
  #       channel: 'stable'
  #       cache: true
        
  #   - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  #     run: flutter pub get
      
  #   - name: Webã‚¢ãƒ—ãƒªã‚’ãƒ“ãƒ«ãƒ‰Web
  #     run: flutter build web

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
  security-scan:
    runs-on: ubuntu-latest
    name: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
    needs: code-quality
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: Flutterç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.5'
        channel: 'stable'
        cache: true
        
    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: flutter pub get
      
    - name: ä¾å­˜é–¢ä¿‚ã®è„†å¼±æ€§ã‚’ã‚¹ã‚­ãƒ£ãƒ³
      run: flutter pub deps --json | grep -E "(dependencies|dev_dependencies)" || echo "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†"
      
    - name: Dartã‚³ãƒ¼ãƒ‰ã®æ½œåœ¨çš„å•é¡Œã‚’ãƒã‚§ãƒƒã‚¯
      run: dart analyze --fatal-infos --fatal-warnings

  # çµ±åˆãƒ†ã‚¹ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  integration-test:
    runs-on: ubuntu-latest
    name: çµ±åˆãƒ†ã‚¹ãƒˆ
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: Flutterç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.5'
        channel: 'stable'
        cache: true
        
    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: flutter pub get
      
    - name: çµ±åˆãƒ†ã‚¹ãƒˆç”¨ç’°å¢ƒè¨­å®š
      run: ./.github/scripts/setup-integration-test-env.sh
      
    - name: çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
      run: |
        # çµ±åˆãƒ†ã‚¹ãƒˆãŒã‚ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
        if [ -d "integration_test" ]; then
          flutter test integration_test/
        else
          echo "çµ±åˆãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
        fi

  # é€šçŸ¥ã¨ãƒ¬ãƒãƒ¼ãƒˆ
  notification:
    runs-on: ubuntu-latest
    name: é€šçŸ¥ã¨ãƒ¬ãƒãƒ¼ãƒˆ
    needs: [code-quality, test, build-android, security-scan]
    if: always()
    
    steps:
    - name: CIçµæžœã®é›†è¨ˆ
      id: ci-result
      run: |
        echo "=== CI/CDçµæžœé›†è¨ˆ ==="
        echo "Code Quality: ${{ needs.code-quality.result }}"
        echo "Test: ${{ needs.test.result }}"
        echo "Build Android: ${{ needs.build-android.result }}"
        echo "Security Scan: ${{ needs.security-scan.result }}"
        
        if [ "${{ needs.code-quality.result }}" == "success" ] && \
           [ "${{ needs.test.result }}" == "success" ] && \
           [ "${{ needs.build-android.result }}" == "success" ] && \
           [ "${{ needs.security-scan.result }}" == "success" ]; then
          echo "result=success" >> $GITHUB_OUTPUT
          echo "message=âœ… ã™ã¹ã¦ã®CI/CDãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ã¾ã—ãŸ" >> $GITHUB_OUTPUT
        else
          echo "result=failure" >> $GITHUB_OUTPUT
          echo "message=âŒ CI/CDãƒã‚§ãƒƒã‚¯ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ" >> $GITHUB_OUTPUT
        fi
    
    - name: CIçµæžœã®é€šçŸ¥
      run: |
        echo "${{ steps.ci-result.outputs.message }}"
        if [ "${{ steps.ci-result.outputs.result }}" == "failure" ]; then
          echo "å¤±æ•—ã—ãŸã‚¸ãƒ§ãƒ–ã®è©³ç´°:"
          [ "${{ needs.code-quality.result }}" != "success" ] && echo "- ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯: ${{ needs.code-quality.result }}"
          [ "${{ needs.test.result }}" != "success" ] && echo "- ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ: ${{ needs.test.result }}"
          [ "${{ needs.build-android.result }}" != "success" ] && echo "- Androidãƒ“ãƒ«ãƒ‰: ${{ needs.build-android.result }}"
          [ "${{ needs.security-scan.result }}" != "success" ] && echo "- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³: ${{ needs.security-scan.result }}"
          exit 1
        fi
        
    - name: æˆåŠŸæ™‚ã®ã‚µãƒžãƒªãƒ¼å‡ºåŠ›
      if: steps.ci-result.outputs.result == 'success'
      run: |
        echo "## ðŸŽ‰ CI/CD æˆåŠŸã‚µãƒžãƒªãƒ¼" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯å®Œäº†" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… å…¨ãƒ†ã‚¹ãƒˆé€šéŽ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Androidãƒ“ãƒ«ãƒ‰æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³å®Œäº†" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ãƒ–ãƒ©ãƒ³ãƒ: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "ã‚³ãƒŸãƒƒãƒˆ: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
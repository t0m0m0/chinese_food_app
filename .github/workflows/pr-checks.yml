name: PRå“è³ªãƒã‚§ãƒƒã‚¯

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # PRå“è³ªãƒã‚§ãƒƒã‚¯
  pr-quality-check:
    runs-on: ubuntu-latest
    name: PRå“è³ªãƒã‚§ãƒƒã‚¯
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Flutterç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.8'
        channel: 'stable'
        cache: true
        
    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: flutter pub get
      
    - name: ã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
      run: flutter packages pub run build_runner build --delete-conflicting-outputs || echo "No build_runner configured"

    - name: ãƒ†ã‚¹ãƒˆç”¨ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
      run: ./.github/scripts/setup-test-env.sh

    - name: å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ï¼ˆå‰Šé™¤ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–ï¼‰
      id: changed-files
      run: |
        git diff --name-status origin/${{ github.base_ref }}..HEAD \
          | awk '
            $1 == "A" { print $2 }
            $1 == "M" { print $2 }
            $1 ~ /^R[0-9]+/ { print $3 }
          ' > changed_files.txt
        echo "Changed files (excluding deleted, using new paths for renamed):"
        cat changed_files.txt
        
    - name: Dartãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯
      run: |
        if grep -q "\.dart$" changed_files.txt; then
          echo "Dartãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’æ¤œå‡º"
          grep "\.dart$" changed_files.txt | xargs flutter analyze
        else
          echo "Dartãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ãªã—"
        fi
        
    - name: ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ãƒã‚§ãƒƒã‚¯
      timeout-minutes: 10
      run: |
        if grep -q "lib/.*\.dart$" changed_files.txt; then
          echo "ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’æ¤œå‡ºã€ã‚³ã‚¢ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ"
          # ã‚³ã‚¢ãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆã‚’é™¤å¤–ï¼‰
          flutter test test/widget_test.dart test/unit/core/types/ test/unit/core/di/ --coverage
          
          # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã®ç¢ºèª
          if [ -f "coverage/lcov.info" ]; then
            echo "ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ"
          else
            echo "âš ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          fi
        else
          echo "ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®å¤‰æ›´ãªã—"
        fi
        
    - name: PRã‚¿ã‚¤ãƒˆãƒ«ã¨ãƒ–ãƒ©ãƒ³ãƒåã‚’ãƒã‚§ãƒƒã‚¯
      run: |
        echo "PR Title: ${{ github.event.pull_request.title }}"
        echo "Branch: ${{ github.head_ref }}"
        
        # ãƒ–ãƒ©ãƒ³ãƒå‘½åè¦å‰‡ãƒã‚§ãƒƒã‚¯
        if [[ "${{ github.head_ref }}" =~ ^(feature|fix|docs|refactor|test)/.+ ]]; then
          echo "âœ… ãƒ–ãƒ©ãƒ³ãƒå‘½åè¦å‰‡ã«æº–æ‹ "
        else
          echo "âŒ ãƒ–ãƒ©ãƒ³ãƒå‘½åè¦å‰‡ã‚¨ãƒ©ãƒ¼: feature/, fix/, docs/, refactor/, test/ã®ã„ãšã‚Œã‹ã§é–‹å§‹ã—ã¦ãã ã•ã„"
          exit 1
        fi
        
    - name: ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯
      run: |
        COMMIT_MSG=$(git log -1 --pretty=%B)
        echo "æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: $COMMIT_MSG"

        if echo "$COMMIT_MSG" | grep -q "ğŸ¤– Generated with \[Claude Code\]"; then
          echo "âœ… Claude Codeç½²åã‚’ç¢ºèª"
        else
          echo "âš ï¸ Claude Codeç½²åãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆæ¨å¥¨ï¼‰"
        fi

  # PRå·®åˆ†è§£æ
  pr-diff-analysis:
    runs-on: ubuntu-latest
    name: PRå·®åˆ†è§£æ
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: è¿½åŠ ãƒ»å‰Šé™¤è¡Œæ•°ã‚’è¨ˆç®—
      run: |
        ADDITIONS=$(git diff --numstat origin/${{ github.base_ref }}..HEAD | awk '{sum += $1} END {print sum}')
        DELETIONS=$(git diff --numstat origin/${{ github.base_ref }}..HEAD | awk '{sum += $2} END {print sum}')
        
        echo "è¿½åŠ è¡Œæ•°: $ADDITIONS"
        echo "å‰Šé™¤è¡Œæ•°: $DELETIONS"

        if [ "$ADDITIONS" -gt 500 ]; then
          echo "âš ï¸ å¤§ããªPRã§ã™ï¼ˆ500è¡Œä»¥ä¸Šã®è¿½åŠ ï¼‰ã€‚åˆ†å‰²ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚"
        fi
        
    - name: ãƒ•ã‚¡ã‚¤ãƒ«ç¨®åˆ¥è§£æ
      run: |
        echo "å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç¨®åˆ¥:"
        git diff --name-only origin/${{ github.base_ref }}..HEAD | \
        awk -F. '{if (NF>1) print $NF}' | sort | uniq -c | sort -nr

  # ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
  dependency-check:
    runs-on: ubuntu-latest
    name: ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: Flutterç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.8'
        channel: 'stable'
        cache: true
        
    - name: pubspec.yamlã®å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯
      run: |
        if git diff --name-only origin/${{ github.base_ref }}..HEAD | grep -q "pubspec.yaml"; then
          echo "pubspec.yamlã®å¤‰æ›´ã‚’æ¤œå‡º"
          flutter pub get
          flutter pub outdated || echo "ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯å®Œäº†"
          echo "ç¾åœ¨ã®ä¾å­˜é–¢ä¿‚:"
          flutter pub deps --no-dev
        else
          echo "pubspec.yamlã®å¤‰æ›´ãªã—"
        fi

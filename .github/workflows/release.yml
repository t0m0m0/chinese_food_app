name: ãƒªãƒªãƒ¼ã‚¹è‡ªå‹•åŒ–

on:
  push:
    tags:
      - 'v*.*.*'  # v1.0.0å½¢å¼ã®ã‚¿ã‚°ã§ãƒˆãƒªã‚¬ãƒ¼

jobs:
  # ãƒªãƒªãƒ¼ã‚¹æº–å‚™
  prepare-release:
    runs-on: ubuntu-latest
    name: ãƒªãƒªãƒ¼ã‚¹æº–å‚™
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: ã‚¿ã‚°æƒ…å ±ã‚’å–å¾—
      id: tag_info
      run: |
        echo "TAG_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        echo "RELEASE_NAME=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        
    - name: ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆã‚’ç”Ÿæˆ
      id: release_notes
      run: |
        # å‰å›žã®ã‚¿ã‚°ã‹ã‚‰ç¾åœ¨ã¾ã§ã®å¤‰æ›´ã‚’å–å¾—
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -n "$PREVIOUS_TAG" ]; then
          echo "å‰å›žã®ã‚¿ã‚°: $PREVIOUS_TAG"
          CHANGES=$(git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD)
        else
          echo "åˆå›žãƒªãƒªãƒ¼ã‚¹"
          CHANGES=$(git log --pretty=format:"- %s")
        fi
        
        # ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆã‚’ä½œæˆ
        cat > release_notes.md << EOF
        ## ðŸŽ‰ ç”ºä¸­è¯ã‚¢ãƒ—ãƒª ${{ steps.tag_info.outputs.TAG_NAME }} ãƒªãƒªãƒ¼ã‚¹
        
        ### ðŸ“± å¯¾å¿œãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 
        - Android (APK)
        - Web (PWAå¯¾å¿œ)
        - iOS (è¦é–‹ç™ºè€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ)
        
        ### ðŸ”„ å¤‰æ›´å†…å®¹
        $CHANGES
        
        ### ðŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        - **Android**: \`app-release.apk\` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        - **Web**: GitHub Pagesã§å…¬é–‹äºˆå®š
        
        ### ðŸ› ï¸ æŠ€è¡“æƒ…å ±
        - Flutter SDK: 3.24.0+
        - Dart SDK: included with Flutter
        - Clean Architectureæº–æ‹ 
        - SQLiteãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
        
        ### ðŸ¤– è‡ªå‹•ç”Ÿæˆ
        ã“ã®ãƒªãƒªãƒ¼ã‚¹ã¯GitHub Actionsã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
        EOF
        
        echo "ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆ:"
        cat release_notes.md
        
    - name: GitHubãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆ
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag_info.outputs.TAG_NAME }}
        release_name: ç”ºä¸­è¯ã‚¢ãƒ—ãƒª ${{ steps.tag_info.outputs.RELEASE_NAME }}
        body_path: release_notes.md
        draft: false
        prerelease: false

  # Android ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰
  build-android-release:
    runs-on: ubuntu-latest
    name: Android ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰
    needs: prepare-release
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: Javaç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Flutterç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.5'
        channel: 'stable'
        cache: true
        
    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: flutter pub get
      
    - name: Android ãƒªãƒªãƒ¼ã‚¹APKã‚’ãƒ“ãƒ«ãƒ‰
      run: |
        # ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰ã®æº–å‚™
        flutter clean
        flutter pub get
        
        # APKãƒ“ãƒ«ãƒ‰ï¼ˆç½²åãªã—ï¼‰
        flutter build apk --release
        
        # ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤‰æ›´
        cp build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/machiapp-${{ github.ref_name }}.apk
        
    - name: ãƒªãƒªãƒ¼ã‚¹APKã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.prepare-release.outputs.upload_url }}
        asset_path: build/app/outputs/flutter-apk/machiapp-${{ github.ref_name }}.apk
        asset_name: machiapp-${{ github.ref_name }}.apk
        asset_content_type: application/vnd.android.package-archive

  # Web ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰
  build-web-release:
    runs-on: ubuntu-latest
    name: Web ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰
    needs: prepare-release
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: Flutterç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.5'
        channel: 'stable'
        cache: true
        
    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: flutter pub get
      
    - name: Web ãƒªãƒªãƒ¼ã‚¹ãƒ“ãƒ«ãƒ‰
      run: |
        flutter clean
        flutter pub get
        flutter build web --release
        
        # Webç”¨ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ä½œæˆ
        cd build/web
        tar -czf ../../machiapp-web-${{ github.ref_name }}.tar.gz .
        cd ../..
        
    - name: Web ãƒ“ãƒ«ãƒ‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.prepare-release.outputs.upload_url }}
        asset_path: machiapp-web-${{ github.ref_name }}.tar.gz
        asset_name: machiapp-web-${{ github.ref_name }}.tar.gz
        asset_content_type: application/gzip

  # GitHub Pages ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆWebç‰ˆï¼‰
  deploy-github-pages:
    runs-on: ubuntu-latest
    name: GitHub Pages ãƒ‡ãƒ—ãƒ­ã‚¤
    needs: build-web-release
    if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4
      
    - name: Flutterç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.32.5'
        channel: 'stable'
        cache: true
        
    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: flutter pub get
      
    - name: Web ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰
      run: flutter build web --release --base-href "/chinese_food_app/"
      
    - name: GitHub Pages ã«ãƒ‡ãƒ—ãƒ­ã‚¤
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: build/web
        cname: # ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ãŒã‚ã‚‹å ´åˆã¯ã“ã“ã«è¨­å®š